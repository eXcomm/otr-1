// <copyright>
// Off The Record Messaging .NET, Copyright (c) 2013
//  based upon the original Off-the-Record Messaging library by
//    Ian Goldberg, Rob Smits, Chris Alexander,
//    Willy Lew, Lisa Du, Nikita Borisov
//    otr@cypherpunks.ca, http://www.cypherpunks.ca/otr/
//
// This library is free software; you can redistribute it and/or
// modify it under the terms of version 2.1 of the GNU Lesser General
// Public License as published by the Free Software Foundation.
//
// This library is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
// Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public
// License along with this library; if not, write to the Free Software
// Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA
// </copyright>
// <author>Bjorn Kuiper</author>
// <email>otr@kuiper.nu</email>

using FluentAssertions;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using OffTheRecord.Protocol.Messages;

namespace OffTheRecord.Tests.Toolkit
{
    [TestClass]
    public class ProtocolTests
    {
        [TestMethod]
        public void OffTheRecord_Validate_parsing_of_DataMessage()
        {
            const string input =
                "?OTR:AAMDSyvyQvLg7pcAAAAAAQAAAAEAAADAVoV88L+aKOU6X25AixfPKDvijKUVHhGdSFZlQpA5XepzoyEqA8ATbjYPwjE7FZApV87oUx+QQog39bJ2GA/zYqrag/xrRzLZfE9K3E7PmUaeUZijLCQA5hTYemzV/crv8SQiLbasDmNDKNi8X/XQuGSPhFD2/jtl13MElkbDWWYiQzX2Ck4lhsHGp0gsNLBhOwkwPGRzmWB+1ltRvb9XqhTuF6S83qGy9iM7pm3yT048awWY4FOG24dukbja1jbNAAAAAAAAAAEAAAANXtnheROJlgrrv2dCFmJ6bYB4YqCkGD2qjQM8s6q391HnAAAAAA==.";

            DataMessage dm = DataMessage.Parse(input);

            dm.Version.Should().Be(3);
            dm.Flags.Should().Be(0);
            dm.SenderInstance.Should().Be(1261171266);
            dm.ReceiverInstance.Should().Be(4074827415);
            dm.SenderKeyId.Should().Be(1);
            dm.ReceiverKeyId.Should().Be(1);
            dm.Y.Should()
                .Be(
                    "56857CF0BF9A28E53A5F6E408B17CF283BE28CA5151E119D4856654290395DEA73A3212A03C0136E360FC2313B15902957CEE8531F90428837F5B276180FF362AADA83FC6B4732D97C4F4ADC4ECF99469E5198A32C2400E614D87A6CD5FDCAEFF124222DB6AC0E634328D8BC5FF5D0B8648F8450F6FE3B65D773049646C35966224335F60A4E2586C1C6A7482C34B0613B09303C647399607ED65B51BDBF57AA14EE17A4BCDEA1B2F6233BA66DF24F4E3C6B0598E05386DB876E91B8DAD636CD");
            dm.Counter.Should().Be(1);
            dm.EncryptedMessage.Should().Be("5ED9E1791389960AEBBF674216");
            dm.MAC.Should().Be("627A6D807862A0A4183DAA8D033CB3AAB7F751E7");
        }

        [TestMethod]
        public void OffTheRecord_Validate_parsing_of_DHCommitMessage()
        {
            const string input =
                "?OTR:AAMC8uDulwAAAAAAAADEdJDE3Q/lG1LdKWVfWc6+NmWhTBvd06+VGvVbH19vhKmGeVZ16dpXsWfqXDFsRVxovU7pFLe0+5GGiTcc16gC681IOJfEsfm9JTpaFOr2XDsJQwHnIhFp8qSkvwfqEwx0FLelaSmI6ipNzlQCtzZ3Y7ihAAMZV3cEc05w0xwHqkIXLtn73+Fohp1RuLw2ubIFbFJRlZcteyK6VFfAN9HBv+TnvsSQ8iHSIBMQpfzZgT1A0IxrboAyg1xPu1XSA65G+HLfoQAAACC9FgJItQxwRnJCFYBGYjofLhZntfzxbHTusuV/5JrT2g==.";

            DHCommitMessage dhcm = DHCommitMessage.Parse(input);

            dhcm.Version.Should().Be(3);
            dhcm.SenderInstance.Should().Be(4074827415);
            dhcm.ReceiverInstance.Should().Be(0);
            dhcm.EncryptedMessage.Should()
                .Be(
                    "7490C4DD0FE51B52DD29655F59CEBE3665A14C1BDDD3AF951AF55B1F5F6F84A986795675E9DA57B167EA5C316C455C68BD4EE914B7B4FB918689371CD7A802EBCD483897C4B1F9BD253A5A14EAF65C3B094301E7221169F2A4A4BF07EA130C7414B7A5692988EA2A4DCE5402B7367763B8A1000319577704734E70D31C07AA42172ED9FBDFE168869D51B8BC36B9B2056C525195972D7B22BA5457C037D1C1BFE4E7BEC490F221D2201310A5FCD9813D40D08C6B6E8032835C4FBB55D203AE46F872DFA1");
            dhcm.HashKey.Should().Be("BD160248B50C70467242158046623A1F2E1667B5FCF16C74EEB2E57FE49AD3DA");
        }

        [TestMethod]
        public void OffTheRecord_Validate_parsing_of_DHKeyMessage()
        {
            const string input =
                "?OTR:AAMKSyvyQvLg7pcAAADALSQOLMyMB7ZF8LeghEQw2HNeP+dnuWe+NAue2s+d1ZtnqVvzXhDJIDG8wdiIZ3NCOYcRRyn11sFEZPeRQ7AoIeh+cNmGccALb91T9HFoISs+/+LW+1jBjiJ9Wn2adtUcZmkukP60VSXF+PnSQGXQKMTXUlOM9QsELm2Z3k6dNMM0hAALDEGvWbSX8wW9ETgKPNx3HINA+dM8NEy+0BPv5laCEDzmyu6s8cAF0Z7pumHys7ZSxR7UunzejGIy7CiE.";

            DHKeyMessage dhkm = DHKeyMessage.Parse(input);

            dhkm.Version.Should().Be(3);
            dhkm.SenderInstance.Should().Be(1261171266);
            dhkm.ReceiverInstance.Should().Be(4074827415);
            dhkm.MPI.Should()
                .Be(
                    "2D240E2CCC8C07B645F0B7A0844430D8735E3FE767B967BE340B9EDACF9DD59B67A95BF35E10C92031BCC1D8886773423987114729F5D6C14464F79143B02821E87E70D98671C00B6FDD53F47168212B3EFFE2D6FB58C18E227D5A7D9A76D51C66692E90FEB45525C5F8F9D24065D028C4D752538CF50B042E6D99DE4E9D34C33484000B0C41AF59B497F305BD11380A3CDC771C8340F9D33C344CBED013EFE65682103CE6CAEEACF1C005D19EE9BA61F2B3B652C51ED4BA7CDE8C6232EC2884");
        }

        [TestMethod]
        public void OffTheRecord_Validate_parsing_of_RevealSignatureMessage()
        {
            const string input =
                "?OTR:AAMRKZwpFoz1R/EAAAAQC0nl/DaDsUlZuO9CZ91smQAAAdJdD0kXUrngjHS6kvdk17DDjXGXyIbIZmgNGo8wlXZBr7LZkct226XTVVhf/6UGUP2Mvgzc22TIe9f4TRTj4hkEk16E/e2ENSos5Dx2tnLtmTzped0Jc1VOTZ9c4o926r/01yXr55ExF7Rr/slAYx1j9BSYCsDbjgLSp3+NHsd1ncof/IayfWI+/90sYRmhNUKu1oDyMq61NZZ1tMPRfBoP5fgJ6yqnmDk5FLLrixNHGHWcmFo5FjB2L5UUJly5vuQrFuAvci+6qUThw5AxyLYmFWMYqyHnQLvW1HBmLUF3n64QorvqXwdu1actMsSiFMrrOUN6dixcgT+kVrQzms7NmWIxwnaOp4ido7XH9w/Lg5KsGu2khR81wbdlYnSb43QzhPB9ZFFm8E3ZbKpK94x+UGKKTPZHKiW7j/w1u6wkUwHPK5lCbbmk+TadVjBH5BojaqE+/f4ktGqxWqK7pOyQPm6dwg3FSL2HPgfxsUVlKvo+nMGX3h3G7iaSBYPLBL8Y9Qu0Y1HpyeMcK5yryb2RtXwjCyXn/VSREdY5z31A7sdKBbU3kEZy2cEipiUT4RXAItXEcZqUA/VHRILFf+HiypuA50KxPW0DtRkwmrE5AlifwmoQkxKPuCXV6peklY3tN+j3/f8=.";

            RevealSignatureMessage rsm = RevealSignatureMessage.Parse(input);

            rsm.Version.Should().Be(3);
            rsm.SenderInstance.Should().Be(698099990);
            rsm.ReceiverInstance.Should().Be(2364884977);
            rsm.Key.Should().Be("0B49E5FC3683B14959B8EF4267DD6C99");
            rsm.EncryptedSignature.Should()
                .Be(
                    "5D0F491752B9E08C74BA92F764D7B0C38D7197C886C866680D1A8F30957641AFB2D991CB76DBA5D355585FFFA50650FD8CBE0CDCDB64C87BD7F84D14E3E21904935E84FDED84352A2CE43C76B672ED993CE979DD0973554E4D9F5CE28F76EABFF4D725EBE7913117B46BFEC940631D63F414980AC0DB8E02D2A77F8D1EC7759DCA1FFC86B27D623EFFDD2C6119A13542AED680F232AEB5359675B4C3D17C1A0FE5F809EB2AA798393914B2EB8B134718759C985A391630762F9514265CB9BEE42B16E02F722FBAA944E1C39031C8B626156318AB21E740BBD6D470662D41779FAE10A2BBEA5F076ED5A72D32C4A214CAEB39437A762C5C813FA456B4339ACECD996231C2768EA7889DA3B5C7F70FCB8392AC1AEDA4851F35C1B76562749BE3743384F07D645166F04DD96CAA4AF78C7E50628A4CF6472A25BB8FFC35BBAC245301CF2B99426DB9A4F9369D563047E41A236AA13EFDFE24B46AB15AA2BBA4EC903E6E9DC20DC548BD873E07F1B145652AFA3E9CC197DE1DC6EE26920583CB04BF18F50BB46351E9C9E31C2B9CABC9BD91B57C230B25E7FD549111D639CF7D40EEC74A05B537904672D9C122A62513E115C022D5C4719A9403F5474482C57FE1E2CA9B80E742B13D6D03B519309AB13902589F");
            rsm.MAC.Should().Be("C26A1093128FB825D5EA97A4958DED37E8F7FDFF");
        }

        [TestMethod]
        public void OffTheRecord_Validate_parsing_of_SignatureMessage()
        {
            const string input =
                "?OTR:AAMSjPVH8SmcKRYAAAHSHKlFfK//TonP5D9qOJiHhyQkEObTaiHFa/AGGeUfSYzYD1PpqchG0yrHENzeOpkAnlsJwxJMlPJt/WsTNq+Pz+7bZmNt01LVozM/hIzU8OIHVSNlwEV1PAY9M0mi0QnNIBmHVyQ3DG9e0QZivVwD6Mjd+Qp9sGD/eSy2BYwCWlX1m8AC6k+i97ajl/Ldg3Cl25FpDbxpXy5uSUhl2tXSKSRjwBCK+wMKMeqrhiIRFFghwStxXTN3VurltsfOH0/FexpsVJQ8+vxBWOvSqDKEYcs3AEYHgwNz6nihKnueust2+flj52V3KNIY5G0qwIpoOEJaIQ53X/KScN6ZkNmD5qIK+Z1OgNoXmtS/Bpv879v/uNhFt5asPcmNw4LZ2i3OrzqwIKu2SsmxenXwZ6e4kz8XSzE0aL3K07qEGEzJ+kn82nYV3NpwDirWMgLq4A5Fc3uIYJAvBCOD+7mqIi9XgfJojvk8q7sqFOogFlkJwN/98saNoGBIkUMfGzFlMclLjuOGvBzztekNW7HNkWEd7tzXDiydCMpUUc2lQKE+pnCSz/2O5DnakWGCA2CFj7y9XoOvft913ENSm+q2NxDY4+vjrsbmeQZFj1Cr3rIXMiuMBB73BRnamNYdAYZnaDr21M95J0Yk.";

            SignatureMessage sm = SignatureMessage.Parse(input);

            sm.Version.Should().Be(3);
            sm.SenderInstance.Should().Be(2364884977);
            sm.ReceiverInstance.Should().Be(698099990);
            sm.EncryptedSignature.Should()
                .Be(
                    "1CA9457CAFFF4E89CFE43F6A38988787242410E6D36A21C56BF00619E51F498CD80F53E9A9C846D32AC710DCDE3A99009E5B09C3124C94F26DFD6B1336AF8FCFEEDB66636DD352D5A3333F848CD4F0E207552365C045753C063D3349A2D109CD2019875724370C6F5ED10662BD5C03E8C8DDF90A7DB060FF792CB6058C025A55F59BC002EA4FA2F7B6A397F2DD8370A5DB91690DBC695F2E6E494865DAD5D2292463C0108AFB030A31EAAB862211145821C12B715D337756EAE5B6C7CE1F4FC57B1A6C54943CFAFC4158EBD2A8328461CB37004607830373EA78A12A7B9EBACB76F9F963E7657728D218E46D2AC08A6838425A210E775FF29270DE9990D983E6A20AF99D4E80DA179AD4BF069BFCEFDBFFB8D845B796AC3DC98DC382D9DA2DCEAF3AB020ABB64AC9B17A75F067A7B8933F174B313468BDCAD3BA84184CC9FA49FCDA7615DCDA700E2AD63202EAE00E45737B8860902F042383FBB9AA222F5781F2688EF93CABBB2A14EA20165909C0DFFDF2C68DA0604891431F1B316531C94B8EE386BC1CF3B5E90D5BB1CD91611DEEDCD70E2C9D08CA5451CDA540A13EA67092CFFD8EE439DA9161820360858FBCBD5E83AF7EDF75DC43529BEAB63710D8E3EBE3AEC6E67906458F50ABDEB217322B8C04");
            sm.MAC.Should().Be("1EF70519DA98D61D018667683AF6D4CF79274624");
        }
    }
}